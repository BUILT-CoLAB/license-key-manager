{% extends "base.html" %}
{% block title %}CPanel | Key Details{% endblock %}
{% block head %}
    {{ super() }}
    
{% endblock %}

{% block topnav %}
nav-link py-3 border-bottom border-top
{% endblock %}

{% block midnav %}
nav-link active py-3 border-bottom
{% endblock %}

{% block content %}
<div id="content-wrapper" class="d-flex flex-column">
	<!-- Main Content -->
	<div id="content">
		<!-- Begin Page Content -->
		<div class="container-fluid special-padding main-body-setting">
			<a href="{{ url_for('main.productDisplay', productid = keyData.productid) }}" class="d-none d-sm-inline-block btn btn-sm btn-info shadow-sm mb-4">
				<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-arrow-left" viewBox="0 0 16 16">
					<path fill-rule="evenodd" d="M15 8a.5.5 0 0 0-.5-.5H2.707l3.147-3.146a.5.5 0 1 0-.708-.708l-4 4a.5.5 0 0 0 0 .708l4 4a.5.5 0 0 0 .708-.708L2.707 8.5H14.5A.5.5 0 0 0 15 8z"/>
				</svg>
				Return to Product
			</a>
			<!-- Page Heading -->
			<div class="d-sm-flex align-items-center justify-content-between mb-4">
				<h1 class="h3 mb-0 text-gray-800">Admin Panel - Key Overview</h1>
				<div class="d-flex justify-content-center">
					<button type="button" class="btn btn-outline-danger ms-2 me-2 action-on-key">Delete</button>
					{% if keyData.status != 2 %}
					<button type="button" class="btn btn-outline-warning ms-2 me-2 action-on-key">Revoke</button>
					{% else %}
					<button type="button" class="btn btn-outline-success ms-2 me-2 action-on-key">Reactivate</button>
					{% endif %}
					<button type="button" class="btn btn-outline-dark ms-2 action-on-key">Reset</button>
				</div>
			</div>
			<!-- Content Row -->
			<div class="container-fluid p-0">
				<div class="card mb-5">
					<h5 class="card-header {% if keyData.status == 2 %}red-header{% endif %}">Key Information</h5>
					<div class="card-body">
						<div class="row justify-content-between">
							<div class="col-auto">
								<p class="card-text">
									<bold class="fw-bold">Product ID: </bold>
									{{ keyData.productid }}
								</p>
								<p class="card-text">
									<bold class="fw-bold">Client's Name: </bold>
									{{ keyData.customername }}
								</p>
								<p class="card-text">
									<bold class="fw-bold">Client's Email address: </bold>
									{{ keyData.customeremail }}
								</p>
								<p class="card-text">
									<bold class="fw-bold">Client's Phone number: </bold>
									{{ keyData.customerphone }}
								</p>
								<p class="card-text">
									<bold class="fw-bold">Serial Key: </bold>
									{{ keyData.serialkey }}
								</p>
								<p class="card-text">
									<bold class="fw-bold">Expiration Date: </bold>
									<span class="timestamp-line">{{ keyData.expirydate }}</span>
								</p>
							</div>
							<div class="col-auto text-end">
								<p class="card-text">Device List: {{ keyData.devices }} / {{ keyData.maxdevices }}</p>
								{%for registration in registrations%}
								<a href="#" class="no-underline">
									<p class="fw-light font-monospace lh-1 fs-6 fst-italic devices-registered">{{registration.hardwareID}}</p>
								</a>
								{%endfor%}
							</div>
						</div>
						<hr style="height: 2px;">
						<h4>Changelogs</h4>
						<div class="col-lg-8 col-md-10 col-12">
							{%for log in logData%}
							<h6 class="mt-4">
								{% if log.action == 'Created' %}
								<span class="p-2 bg-light shadow rounded text-success"> Created</span> 
								{% elif log.action == 'Revoked' %}                  
								<span class="p-2 bg-light shadow rounded text-danger"> Revoked</span>
								{% elif log.action == 'Reset' %}  
								<span class="p-2 bg-light shadow rounded text-secondary"> Reset</span>
								{% elif log.action == 'Reactivated' %}  
								<span class="p-2 bg-light shadow rounded text-warning"> Reactivated</span>
								{% elif log.action == 'Activated' %}  
								<span class="p-2 bg-light shadow rounded text-success"> Validated</span>
								{% else %}
								<span class="p-2 bg-light shadow rounded text-danger"> {{log.action}}</span>
								{% endif %}
								- <span class="timestamp-line">{{log.timestamp}}</span>
							</h6>
							{%endfor%}
						</div>
						<!--end col-->
					</div>
				</div>
			</div>
		</div>
		<!-- /.container-fluid -->
	</div>
	<div class="modal" id="modalConfirmation" tabindex="-1">
		<div class="modal-dialog modal-dialog-centered modal-lg">
			<div class="modal-content">
				<div class="modal-header">
					<h5 class="modal-title">Confirmation</h5>
					<button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
				</div>
				<div class="modal-body">
					<p>You are about to <span id="actionCode">---</span> this key. This action is irreversible and will be logged into the database.</p>
					<p>Do you wish to proceed?</p>
				</div>
				<div class="modal-footer">
					<button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
					<button id="proceedAffirmative" type="button" class="btn btn-outline-danger">Confirm</button>
				</div>
			</div>
		</div>
	</div>
	<div class="modal" id="modalConfirmationDelHW" tabindex="-1">
		<div class="modal-dialog modal-dialog-centered modal-lg">
			<div class="modal-content">
				<div class="modal-header">
					<h5 class="modal-title">Confirmation</h5>
					<button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
				</div>
				<div class="modal-body">
					<p>You are about to unlink the Hardware ID number: '<span id="actionHW">---</span>' from this key. This action is irreversible and will be logged into the database.</p>
					<p>Do you wish to proceed?</p>
				</div>
				<div class="modal-footer">
					<button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
					<button id="confirmRemoval" type="button" class="btn btn-outline-danger">Confirm</button>
				</div>
			</div>
		</div>
	</div>
	<!-- Footer -->
	<footer class="sticky-footer bg-white">
		<div class="container my-auto">
			<div class="copyright text-center my-auto">
				<span>Copyright Â© Key License Manager Pro 2022</span>
			</div>
		</div>
	</footer>
	<!-- End of Footer -->
{% endblock %}

{% block scripts %}
<script>
    let timestamps = document.getElementsByClassName("timestamp-line");
    for(let i = 0; i < timestamps.length; i++){
        if( timestamps[i].textContent === "0" ){
            timestamps[i].textContent = "Not specified";
            continue;
        }
        let timestampV = timestamps[i].textContent;
        let dateObj = new Date(timestampV * 1000);

        var month = dateObj.getUTCMonth() + 1;
        var day = dateObj.getUTCDate();
        var year = dateObj.getUTCFullYear();
        var hours = dateObj.getHours();
        var minutes = "0" + dateObj.getMinutes();
        var seconds = "0" + dateObj.getSeconds();

        let newdate = day + "/" + month + "/" + year + " - " + hours + ':' + minutes.substr(-2) + ':' + seconds.substr(-2);
        timestamps[i].textContent = newdate;
    }
</script>

<script src="{{ url_for('static', filename='bootstrap.bundle.min.js') }}"></script>

<script>
let modalConfirmation = new bootstrap.Modal( document.getElementById('modalConfirmation') )
let actionCode = document.getElementById("actionCode")
let pendingAction = {}

////////////////// Buttons
let actionButtons = document.getElementsByClassName("action-on-key");
for(let i = 0; i < actionButtons.length; i++)
    actionButtons[i].addEventListener("click", actionOnKeys.bind(this, i))
document.getElementById("proceedAffirmative").addEventListener("click", confirmSubmission.bind(this))
//////////////////////////

function actionOnKeys(buttonNumber){
    if(buttonNumber === 0)
        pendingAction['type'] = "DELETE";
    else if(buttonNumber === 1)
        pendingAction['type'] = "SWITCHSTATE";
    else
        pendingAction['type'] = "RESET";
    pendingAction['keyList'] = [{{keyData.id}}];
    actionCode.innerText = translatePendingAction(pendingAction['type'])
    modalConfirmation.show();
}

function translatePendingAction(words){
    if(words != "SWITCHSTATE")
        return words.toLowerCase();
    return "revoke or reactivate"
}

function confirmSubmission(){
    let updateData = {
        'keyList' : pendingAction['keyList'],
        'action' : pendingAction['type']
    }

    var httpRequest = new XMLHttpRequest();
    httpRequest.open("POST", "/cpanel/editkeys", true);
    httpRequest.setRequestHeader('Content-Type', 'application/json');
    httpRequest.send(JSON.stringify(updateData));

    httpRequest.onreadystatechange = function() {
        if (httpRequest.readyState === 4) {
            if (httpRequest.status === 200) {
                if(pendingAction['type'] == "DELETE")
                    window.location.href = "{{ url_for('main.productDisplay', productid = keyData.productid) }}"
                else
                    location.reload()
            } else {
                console.error("Something wrong happened!")
            }
        }
    }
}
</script>

<script>
let modalConfirmation2 = new bootstrap.Modal( document.getElementById('modalConfirmationDelHW') )
let HWIDFiller = document.getElementById("actionHW");
let buttonConfirm = document.getElementById("confirmRemoval");

let hardwareRemoval = document.getElementsByClassName("devices-registered");
for(let i = 0; i < hardwareRemoval.length; i++)
        hardwareRemoval[i].addEventListener("click", confirmModalShow)
buttonConfirm.addEventListener("click", confirmRemovalHWID)

function confirmModalShow(event){
    HWIDFiller.innerText = event.target.innerText;
    modalConfirmation2.show();
}

function confirmRemovalHWID(){
    let updateData = {
        'hardwareID' : HWIDFiller.innerText
    }

    var httpRequest = new XMLHttpRequest();
    httpRequest.open("POST", '/cpanel/removehwid/' + '{{ keyData.id }}', true);
    httpRequest.setRequestHeader('Content-Type', 'application/json');
    httpRequest.send(JSON.stringify(updateData));

    httpRequest.onreadystatechange = function() {
        if (httpRequest.readyState === 4) {
            if (httpRequest.status === 200) {
                location.reload()
            } else {
                console.error("Something wrong happened!")
            }
        }
    }
    modalConfirmation2.hide();
}
</script>
{% endblock %}