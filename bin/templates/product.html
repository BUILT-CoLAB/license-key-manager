{% extends "base.html" %}
{% block title %}CPanel | Product Details{% endblock %}
{% block head %}
    {{ super() }}
    
{% endblock %}

{% block topnav %}
nav-link py-3 border-bottom border-top
{% endblock %}

{% block midnav %}
nav-link active py-3 border-bottom
{% endblock %}

{% block content %}
<div id="content-wrapper" class="d-flex flex-column">
	<!-- Main Content -->
	<div id="content">
		<!-- Begin Page Content -->
		<div class="container-fluid special-padding main-body-setting">
			<!-- Page Heading -->
			<div class="d-sm-flex align-items-center justify-content-between mb-4">
				<h1 class="h3 mb-0 text-gray-800 dynamic-mode-t">Admin Panel - Product Overview</h1>
				<a id="createProductCall" href="#" class="d-none d-sm-inline-block btn btn-sm btn-primary shadow-sm">
					<svg class="bi" width="16" height="16" role="img" aria-label="Home">
						<use xlink:href="#addproduct"/>
					</svg>
					Generate new Key
				</a>
			</div>
			<!-- Content Row -->
			<div class="container-fluid p-0">
				<div class="card mb-5">
					<h5 class="card-header dynamic-mode-bg-l dynamic-mode-t dynamic-mode-border">Product Information</h5>
					<div class="card-body dynamic-mode-bg dynamic-mode-t">
						<p class="card-text">
							<bold class="font-weight-bold">Product ID: </bold>
							{{ prodID }}
						</p>
						<p class="card-text">
							<bold class="font-weight-bold">Name: </bold>
							{{ pcontent.name }}
						</p>
						<p class="card-text">
							<bold class="font-weight-bold">API Key: </bold>
							{{ pcontent.apiK }}
						</p>
						<button id="getPubK" type="button" class="btn btn-primary">Get Public Key</button>
					</div>
				</div>
				<div class="table-responsive custom-table-responsive">
					{% if keyList|length > 0 %}
					<table class="table custom-table">
						<thead>
							<tr>
								<th scope="col">---</th>
								<th scope="col">Key ID</th>
								<th scope="col">Customer's Name</th>
								<th scope="col">Serial Number</th>
								<th scope="col">Device Limit</th>
								<th scope="col">Status</th>
							</tr>
						</thead>
						<tbody>
							{%for key in keyList%}
							<tr scope="row">
								<th scope="row">
									<label class="control control--checkbox">
										<input type="checkbox" class="checkbox-selector-marker"/>
										<div class="control__indicator"></div>
									</label>
								</th>
								<td class="key-id-data">
									{{ key.id }}
								</td>
								<td>{{ key.customername }}</td>
								<td>{{ key.serialkey }}</td>
								<td>
									{{ key.maxdevices }}
									<small class="d-block">
										<bold>Currently active:</bold>
										{{ key.devices }}
									</small>
								</td>
								{% if key.status == 0 %}
								<td class="status-inactive">Awaiting Activation</td>
								{% elif key.status == 1 %}                  
								<td class="status-active">Active</td>
								{% elif key.status == 2 %}  
								<td class="status-revoked">Revoked</td>
								{% endif %}
								<td>
									<a href="{{ url_for('main.keyDataDisplay', keyid = key.id) }}">
									<button type="button" class="btn btn-outline-info">></button>
									</a>
								</td>
							</tr>
							<tr class="spacer">
								<td colspan="100"></td>
							</tr>
							{%endfor%}
							</tr>
						</tbody>
					</table>
					{% else %}
					<h2 class="empty-header-text">Oh no ... There are no keys here :(</h2>
					<p class="empty-paragraph-text">Click on "Generate new Key" to get started!</p>
					{% endif %}
				</div>
				<div class="d-flex justify-content-center mb-5">
					<button type="button" class="btn btn-lg btn-outline-danger ms-4 me-4 action-on-key disabled">Delete</button>
					<button type="button" class="btn btn-lg btn-outline-dynamic ms-4 me-4 action-on-key disabled">Reset</button>
				</div>
			</div>
		</div>
		<!-- /.container-fluid -->
	</div>
	<!-- End of Main Content -->
	<!-- Footer -->
	<footer class="sticky-footer dynamic-mode-bg dynamic-mode-t">
		<div class="container my-auto">
			<div class="copyright text-center my-auto">
				<span>Copyright Â© Key License Manager Pro 2022</span>
			</div>
		</div>
	</footer>
	<!-- End of Footer -->
	<div class="modal" id="modalCreation" tabindex="-1">
		<div class="modal-dialog modal-dialog-centered modal-lg">
			<div class="modal-content dynamic-mode-bg dynamic-mode-border-s dynamic-mode-t">
				<div class="modal-header">
					<h5 class="modal-title" id="exampleModalLabel">Publish new Key</h5>
					<button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
				</div>
				<div class="modal-body">
					<div class="row g-3 align-items-center mb-4">
						<div class="col-3">
							<label for="inputPassword6" class="col-form-label">Customer's name</label>
						</div>
						<div class="col-4">
							<input type="text" id="inputName" class="form-control dynamic-form" aria-describedby="passwordHelpInline">
						</div>
						<div class="col-auto">
							<span id="nameHelpInline" class="form-text text-danger">
							</span>
						</div>
					</div>
					<div class="row g-3 align-items-center mb-4">
						<div class="col-3">
							<label for="inputPassword6" class="col-form-label">Customer's email</label>
						</div>
						<div class="col-4">
							<input type="text" id="inputEmail" class="form-control dynamic-form" aria-describedby="passwordHelpInline">
						</div>
						<div class="col-auto">
							<span id="emailHelpInline" class="form-text text-danger">
							</span>
						</div>
					</div>
					<div class="row g-3 align-items-center mb-4">
						<div class="col-3">
							<label for="inputPassword6" class="col-form-label">Customer's phone</label>
						</div>
						<div class="col-4">
							<input type="text" id="inputPhone" class="form-control dynamic-form" aria-describedby="passwordHelpInline">
						</div>
						<div class="col-auto">
							<span id="phoneHelpInline" class="form-text text-danger">
							</span>
						</div>
					</div>
					<div class="row g-3 align-items-center mb-4">
						<div class="col-3">
							<label for="inputPassword6" class="col-form-label">Max Devices</label>
						</div>
						<div class="col-4">
							<input type="number" id="inputMaxDevices" class="form-control dynamic-form" aria-describedby="passwordHelpInline">
						</div>
						<div class="col-auto">
							<span id="passwordHelpInline" class="form-text">
							If empty, the default value will be 3.
							</span>
						</div>
					</div>
					<div class="row g-3 align-items-center mb-4">
						<div class="col-3">
							<label for="inputPassword6" class="col-form-label">Expiry Date:</label>
						</div>
						<div class="col-4">
							<input class="dynamic-form dynamic-mode-border" type="date" id="expiryDate" name="expiry-date" style="padding: 0.375rem 0.75rem;">
						</div>
						<div class="col-auto">
							<span id="dateHelpInline" class="form-text">
							If empty, the license will be lifetime.
							</span>
						</div>
					</div>
					<hr>
					<h6>Notes:</h6>
					<span class="form-text">- The serial key will be automatically generated by the server.<br></span>
					<span class="form-text">- The date will be stored relative to Posix time.<br></span>
					<span class="form-text">- All fields are mandatory.</span>
				</div>
				<div class="modal-footer">
					<button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
					<button id="submitCreation" type="button" class="btn btn-primary">Create Product</button>
				</div>
			</div>
		</div>
	</div>
</div>
{% endblock %}

{% block scripts %}
<script src="{{ url_for('static', filename='bootstrap.bundle.min.js') }}"></script>
<script>
    function applyClassChange(HTMLElement, className, isAdd){
        if(isAdd)
            HTMLElement.classList.add(className)
        else
            HTMLElement.classList.remove(className)
    }

    let modalCreation = new bootstrap.Modal( document.getElementById('modalCreation') )
    document.getElementById("createProductCall").addEventListener("click", createProductProcess.bind(this))
    document.getElementById("submitCreation").addEventListener("click", submitProductProcess.bind(this))
    document.getElementById("getPubK").addEventListener("click", getPubKey.bind(this))

    function createProductProcess(){
        modalCreation.show();
    }

    async function getPubKey(){
        await navigator.clipboard.writeText(`{{ pubKey }}`);
        alert("Public Key has been copied to your clipboard.");
    }

    function submitProductProcess(){
        let name = document.getElementById("inputName").value;
        let email = document.getElementById("inputEmail").value;
        let phoneNumber = document.getElementById("inputPhone").value;
        let maxDevices = document.getElementById("inputMaxDevices").value;
        let dateLimit = document.getElementById("expiryDate").value;

        // Check State
        if( !checkInputs(name, email, phoneNumber, maxDevices, dateLimit) )
            return;

        let dateObject = new Date(dateLimit);
        let productData = {
            'name' : name,
            'maxDevices' : maxDevices.length === 0 ? 3 : maxDevices,
            'email' : email,
            'phoneNumber' : phoneNumber,
            'expiryDate' : dateLimit.length === 0 ? 0 : Math.floor(dateObject.getTime() / 1000)
        }

        var httpRequest = new XMLHttpRequest();
        httpRequest.open("POST", "/cpanel/product/id/" + "{{ prodID }}" + "/createkey", true);
        httpRequest.setRequestHeader('Content-Type', 'application/json');
        httpRequest.send(JSON.stringify(productData));

        httpRequest.onreadystatechange = function() {
                if (httpRequest.readyState === 4) {
                    if (httpRequest.status === 200) {
                        location.reload()
                    } else {
                        console.error("Something wrong happened!")
                    }
                }
            }
    }

    function checkInputs(name, email, phoneNumber, maxDevices, expiryDate){
        let mayContinue = true;
        let validatorBuffer = false;

        // Check Name
        validatorBuffer = /\d/.test(name) || name.length === 0;
        document.getElementById("nameHelpInline").innerText = validatorBuffer ? "You have entered an invalid name." : " ";
        mayContinue = !mayContinue ? false : !validatorBuffer;

        // Check Email
        let emailRegex = /^[a-zA-Z0-9.!#$%&'*+/=?^_`{|}~-]+@[a-zA-Z0-9-]+(?:\.[a-zA-Z0-9-]+)*$/;
        validatorBuffer = email.match(emailRegex);
        document.getElementById("emailHelpInline").innerText = validatorBuffer ? " " : "You have entered an invalid email.";
        mayContinue = !mayContinue ? false : validatorBuffer;

        // Check PhoneNumber
        validatorBuffer = /^\d+$/.test(phoneNumber);
        document.getElementById("phoneHelpInline").innerText = validatorBuffer ? " " : "You have entered an invalid phone number.";
        mayContinue = !mayContinue ? false : validatorBuffer;

        // Check Expiry Date
        if(expiryDate.length !== 0){
            let dateObject = new Date(expiryDate);
            let HTMLObject = document.getElementById("dateHelpInline");
            validatorBuffer = Math.floor(dateObject.getTime()/1000) > Math.floor(Date.now() / 1000)
            HTMLObject.innerText = validatorBuffer ? " " : "The expiration must occurr after today.";
            applyClassChange( HTMLObject, "text-danger", !validatorBuffer)
            return !mayContinue ? false : validatorBuffer
        }
        return mayContinue
    }
</script>

<!-- The following script handles all features related to 'Delete', 'Revoke', 'Reset', 'More Info' -->
<script>
    // Acquire Elements
    let selectedList = [];
    let selectableList = document.getElementsByClassName("checkbox-selector-marker");
    let selectableIDs = document.getElementsByClassName("key-id-data");

    ////////////////// Buttons
    let actionButtons = document.getElementsByClassName("action-on-key");
    //////////////////////////


    // Assign Event Listeners
    for(let i = 0; i < selectableList.length; i++)
        selectableList[i].addEventListener("change", selectKey.bind(this, i))
    
    for(let i = 0; i < actionButtons.length; i++)
        actionButtons[i].addEventListener("click", actionOnKeys.bind(this, i))
    //////////////////////////

    function selectKey(keyIndex){
        addIfNotExists(selectedList, parseInt(selectableIDs[keyIndex].textContent) );
        updateButtons();
    }

    function actionOnKeys(buttonNumber){
        let action = "";
        if(buttonNumber === 0)
            action = "DELETE";
        else
            action = "RESET";
        
        let updateData = {
            'keyList' : selectedList,
            'action' : action
        }

        var httpRequest = new XMLHttpRequest();
        httpRequest.open("POST", "/cpanel/editkeys", true);
        httpRequest.setRequestHeader('Content-Type', 'application/json');
        httpRequest.send(JSON.stringify(updateData));

        httpRequest.onreadystatechange = function() {
            if (httpRequest.readyState === 4) {
                if (httpRequest.status === 200) {
                    location.reload()
                } else {
                    console.error("Something wrong happened!")
                }
            }
        }
    }

    /// BUTTONS SECTION
    let buttonsOff = true;
    function updateButtons(){
        if(selectedList.length === 0 && buttonsOff)
            return;
        if(selectedList.length > 0 && !buttonsOff)
            return;
        if(selectedList.length === 0 && !buttonsOff)
            setButtonState(false);
        if(selectedList.length > 0 && buttonsOff)
            setButtonState(true);
    }

    function setButtonState(enableButton){
        for(let i = 0; i < actionButtons.length; i++)
            if(enableButton)
                actionButtons[i].classList.remove("disabled");
            else
                actionButtons[i].classList.add("disabled")
        buttonsOff = !enableButton;
    }

    /// UTILITIES
    function addIfNotExists(array, value){
        let indexL = array.indexOf(value)
        if(indexL === -1)
            array.push(value);
        else
            array.splice(indexL, 1);
    }
</script>
{% endblock %}